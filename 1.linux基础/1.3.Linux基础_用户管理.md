## LinuxåŸºç¡€: ç”¨æˆ·ç®¡ç†

-Author: bavdu

-Email: bavduer@gmail.com

-Github: https://github.com/bavdu

---

- è·å–ç”¨æˆ·å’Œç»„çš„ä¿¡æ¯
- ç”¨æˆ·å’Œç»„çš„ç›¸å…³é…ç½®æ–‡ä»¶
- ç”¨æˆ·ç®¡ç† useradd  userdel(10000ğŸŒŸ)
- ç”¨æˆ·ç»„ç®¡ç† groupadd groupdel
- ç”¨æˆ·å¯†ç ç®¡ç† passwd(10000ğŸŒŸ)
- æ–‡ä»¶åŸºæœ¬æƒé™r w x
- ç®¡ç†æ–‡ä»¶åŸºæœ¬æƒé™ UGO(10000ğŸŒŸ)
- suid  sgid  sticky(äº†è§£å³å¯)
- æ³¨æ„å¸ƒç½®ä½œä¸šï¼ï¼ï¼

---

##### ä»€ä¹ˆæ˜¯ç”¨æˆ·ï¼Ÿä»€ä¹ˆæ˜¯ç»„ï¼Ÿ

åœ¨Linuxç³»ç»Ÿä¸­, æˆ‘ä»¬çŸ¥é“rootç”¨æˆ·æ˜¯è¶…çº§ç®¡ç†å‘˜ç”¨æˆ·, æ²¡æœ‰å®ƒåŠ¨ä¸äº†çš„æ–‡ä»¶å’Œç›®å½•, ä½†æ˜¯æˆ‘ä»¬åˆçŸ¥é“ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨rootæ˜¯éå¸¸å±é™©çš„ä¸€ä»¶äº‹æƒ…, é‚£æ˜¯å› ä¸º"è¯¯åˆ æ–‡ä»¶"ã€"é”™è¯¯æ‰§è¡Œè„šæœ¬"ã€"éæ³•æ”¹åŠ¨æ–‡ä»¶å†…å®¹"ç­‰ç­‰éƒ½ä¼šé€ æˆä¸å¯ä¼°é‡çš„åæœ. é‚£ä¹ˆæœ‰æ²¡æœ‰å®‰å…¨çš„ç®¡ç†å‘˜è´¦æˆ·å‘¢?

åœ¨æˆ‘ä»¬Linuxä¸­é™¤äº†uid=0(*é€šè¿‡id rootè·å–*)çš„rootå¸æˆ·ä»¥å¤–è¿˜æä¾›äº†999ä¸ªç³»ç»Ÿç®¡ç†å‘˜å¸æˆ·,ä»–ä»¬è¢«ç³»ç»Ÿé¢„ç•™å‡ºæ¥,ä½œä¸ºç³»ç»Ÿçš„ç®¡ç†å‘˜å¸æˆ·,ä»–ä»¬å¿…é¡»åœ¨å¿…è¦æ—¶æ‰èƒ½è¢«æå‡è‡³æœ€é«˜æƒé™, ä½†æ˜¯å¹³æ—¶å°±æ˜¯æ™®æ™®é€šé€šçš„å¸æˆ·,æˆ‘ä»¬ä¹Ÿå¯ä»¥ç†è§£ä¸ºæ¼«å¨ç”µå½±ä¸­çš„ç»¿å·¨äºº, å¹³æ—¶å°±æ˜¯ä¸€ä¸ªç­çº³åšå£«, è€Œå˜èº«ä¹‹åå°±æˆäº†å…·å¤‡è¶…èƒ½åŠ›çš„ç»¿å·¨äºº. å¦å¤–åœ¨ç³»ç»Ÿä¸­è¿˜æœ‰å¤§çº¦å››åƒä¸ªæ™®é€šç”¨æˆ·, è¿™äº›åŠä»¥ä¸Šçš„æ‰€æœ‰ç”¨æˆ·çš„æ„ä¹‰åœ¨äº:

1. ä½œä¸ºç³»ç»Ÿä¸­æ‰€å®‰è£…çš„ç¬¬ä¸‰æ–¹æœåŠ¡çš„è¿è¡Œèº«ä»½
2. æ ¹æ®æƒé™æ¥æ§åˆ¶ç¬¬ä¸‰æ–¹æœåŠ¡èƒ½å¤Ÿè®¿é—®çš„æ–‡ä»¶åŠç›®å½•
3. æ ¹æ®æƒé™æ¥æ§åˆ¶ç¬¬ä¸‰æ–¹æœåŠ¡æ˜¯å¦èƒ½è·å–æŒ‡å®šçš„æ–‡ä»¶å†…å®¹

åœ¨Linuxç³»ç»Ÿä¸­, æˆ‘ä»¬è¿˜ä¼šå‘ç°æœ‰ç»„çš„æ¦‚å¿µ, ç»„ä¹‹æ‰€ä»¥å­˜åœ¨çš„æ„ä¹‰å°±åœ¨äº, æ–¹ä¾¿æ‰¹é‡çš„ç®¡ç†ç”¨æˆ·, ä»¥æ­¤æ¥è§„èŒƒç”¨æˆ·çš„æƒé™å’Œè¡Œä¸º. ä¸€ä¸ªç»„ä¸­åŒ…å«å¤šä¸ªç”¨æˆ·, ä¸€ä¸ªç”¨æˆ·å¯ä»¥å±äºå¤šä¸ªç»„.

---

##### è·å–ç”¨æˆ·å’Œç»„çš„ä¿¡æ¯

```shell
##è·å–ç”¨æˆ·çš„ä¿¡æ¯
[root@linux_basis ~]# cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
......

##æŸ¥çœ‹ç”¨æˆ·çš„å¯†ç ä¿¡æ¯
[root@linux_basis ~]# cat /etc/shadow
root:$6$E/4cwlIxV7b0/ce3$9U3IFTYoXEihzTJiYzHcowwHU8kjEtpYo7Iz10::0:99999:7:::
bin:*:17834:0:99999:7:::
daemon:*:17834:0:99999:7:::
adm:*:17834:0:99999:7:::
lp:*:17834:0:99999:7:::
sync:*:17834:0:99999:7:::
shutdown:*:17834:0:99999:7:::
halt:*:17834:0:99999:7:::
mail:*:17834:0:99999:7:::
......

##æŸ¥çœ‹ç»„çš„ä¿¡æ¯
[root@linux_basis ~]# cat /etc/group
root:x:0:
bin:x:1:
daemon:x:2:
sys:x:3:
adm:x:4:
tty:x:5:
disk:x:6:
lp:x:7:
mem:x:8:
kmem:x:9:
wheel:x:10:bavduer
cdrom:x:11:
mail:x:12:postfix
......
```



##### ç”¨æˆ·åŠç»„çš„åˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹ã€æŸ¥è¯¢åŠè®¾ç½®å¸æˆ·å¯†ç 

```shell
##ç”¨æˆ·åŠç»„çš„åˆ›å»º
[root@linux_basis ~]# groupadd -g 966 nginx
[root@linux_basis ~]# useradd -u 998 -g 966 -s /sbin/nologin -d /opt/nginx nginx
[root@linux_basis ~]# id nginx
uid=998(nginx) gid=966(nginx) ç»„=966(nginx)
[root@linux_basis ~]# tail -1 /etc/passwd
nginx:x:998:966::/opt/nginx:/sbin/nologin
[root@linux_basis ~]# tail -1 /etc/shadow
nginx:!!:17989:0:99999:7:::
[root@linux_basis ~]# tail -1 /etc/group
nginx:x:966:

##è®¾ç½®ç”¨æˆ·å¯†ç 
[root@linux_basis ~]# passwd nginx
Changing password for user nginx.
New password:
BAD PASSWORD: The password is shorter than 8 characters
Retype new password:
passwd: all authentication tokens updated successfully.

##ç”¨æˆ·åŠç»„çš„ä¿®æ”¹
[root@linux_basis ~]# usermod -u 988 -s /bin/bash nginx
[root@linux_basis ~]# groupmod -g 666 nginx
[root@linux_basis ~]# id nginx
uid=988(nginx) gid=666(nginx) ç»„=666(nginx)
[root@linux_basis ~]# tail -1 /etc/passwd
nginx:x:988:666::/opt/nginx:/bin/bash
[root@linux_basis ~]# tail -1 /etc/shadow
nginx:!!:17989:0:99999:7:::
[root@linux_basis ~]# tail -1 /etc/group
nginx:x:666:

##åˆ‡æ¢ç”¨æˆ·
[root@linux_basis ~]# su - nginx
[nginx@linux_basis ~]$ exit
logout
[root@linux_basis ~]#

##ç”¨æˆ·åŠç»„çš„åˆ é™¤
[root@linux_basis ~]# userdel -r nginx
[root@linux_basis ~]# groupdel nginx
groupdelï¼šâ€œnginxâ€ç»„ä¸å­˜åœ¨   #(å› ä¸ºè¢«userdel -r nginxåˆ æ‰äº†)

##æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
[root@linux_basis ~]# id nginx
id: nginx: no such user
```



##### æ–‡ä»¶çš„åŸºæœ¬æƒé™rwx

```shell
ls -l == ll

UGO rwx
Uï¼šæ‹¥æœ‰è€…
Gï¼šæ‰€å±ç»„
Oï¼šå…¶ä»–äºº

rï¼š è¯»
wï¼š å†™
xï¼š æ‰§è¡Œ

##é•¿æ¨¡å¼æŸ¥çœ‹æ–‡ä»¶åŠç›®å½•è·å–å…¶ä¿¡æ¯
[root@linux_basis ~]# touch /mnt/linux_file_001.txt
[root@linux_basis ~]# ls -l /mnt/linux_file_001.txt
-rw-r--r--. 1 root root 27 Apr  4 07:11 /mnt/linux_file_001.txt
[root@linux_basis ~]#
[root@linux_basis ~]# mkdir /mnt/linux_dir_001
[root@linux_basis ~]# ls -ld /mnt/linux_dir_001
drwxr-xr-x 2 root root 6 Apr  4 07:11 /mnt/linux_dir_001

##æ–‡ä»¶åŸºæœ¬æƒé™ä¿®æ”¹ä¹‹è¯»å†™æ‰§è¡Œ
[root@linux_basis ~] ls -l /mnt/linux_file_001.txt

-rw-r--r--. 1 root root 27 Apr  4 07:11 /mnt/linux_file_001.txt


[root@linux_basis ~] chmod u+x,g+w,o-r /mnt/linux_file_001.txt


[root@linux_basis ~] ls -l /mnt/linux_file_001.txt
-rwxrw----. 1 root root 27 Apr  4 07:11 /mnt/linux_file_001.txt

##æ–‡ä»¶åŸºæœ¬æƒé™ä¿®æ”¹ä¹‹æ‹¥æœ‰è€…å’Œæ‰€å±ç»„
[root@linux_basis ~] ls -l /mnt/linux_file_001.txt
-rwxrw----. 1 root root 27 Apr  4 07:11 /mnt/linux_file_001.txt


[root@linux_basis ~] chown nginx:nginx /mnt/linux_file_001.txt


[root@linux_basis ~] ls -l /mnt/linux_file_001.txt
-rwxrw----. 1 nginx nginx 27 Apr  4 07:11 /mnt/linux_file_001.txt

##æ‰¹é‡ä¿®æ”¹
[root@linux_basis ~] touch /mnt/linux_dir_001/file{001..100}
[root@linux_basis ~] ls -l /mnt/linux_dir_001/file007
-rw-r--r-- 1 root root 0 Apr  4 07:26 /mnt/linux_dir_001/file007
[root@linux_basis ~] chown -R nginx:nginx /mnt/linux_dir_001/
[root@linux_basis ~] ls -l /mnt/linux_dir_001/file007
-rw-r--r-- 1 nginx nginx 0 Apr  4 07:26 /mnt/linux_dir_001/file007
```



#### ç‰¹æ®Šæƒé™  U G O

SUID: å¯¹ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·è¿›è¡ŒæŸä¸ªç‰¹å®šå‘½ä»¤çš„ææƒ â€”  sudo

SGID: å¯¹ç›®å½•å¢åŠ è¯¥æƒé™å, è¯¥ç›®å½•ä¸‹åˆ›å»ºçš„æ–‡ä»¶éƒ½ç»§æ‰¿è¯¥ç›®å½•çš„æ‰€å±ç»„

Sticky: é’ˆå¯¹ç›®å½•å¢åŠ è¯¥æƒé™å, è¯¥ç›®å½•ä¸‹åˆ›å»ºçš„æ–‡ä»¶åªèƒ½ç”±åˆ›å»ºè€…åˆ é™¤, å…¶ä½™äººæ²¡æœ‰æ“ä½œæƒé™

```shell
##SUID
[bavduer@system_manager ~]$ ls -l /opt/file001
-rwxr-xr-x 1 root root 0 Feb 19 14:41 /opt/file001
[bavduer@system_manager ~]$ chmod 644 /opt/file001
chmod: changing permissions of â€˜/opt/file001â€™: Operation not permitted
[bavduer@system_manager ~]$ sudo chmod u+s /usr/bin/chmod
[bavduer@system_manager ~]$ chmod 644 /opt/file001
[bavduer@system_manager ~]$ ls -l /opt/file001
-rw-r--r-- 1 root root 0 Feb 19 14:41 /opt/file001


##SGID
[bavduer@system_manager ~]$ sudo mkdir /opt/directory001
[bavduer@system_manager ~]$ ls -ld /opt/directory001/
drwxr-xr-x 2 root root 6 Feb 19 15:16 /opt/directory001/
[bavduer@system_manager ~]$ sudo chgrp bavduer /opt/directory001/
[bavduer@system_manager ~]$ sudo chmod g+s /opt/directory001/
[bavduer@system_manager ~]$ sudo touch /opt/directory001/test001.txt
[bavduer@system_manager ~]$ ls -l /opt/directory001/test001.txt
-rw-r--r-- 1 root bavduer 0 Feb 19 15:19 /opt/directory001/test001.txt


##Sticky: é’ˆå¯¹ç›®å½•è¿›è¡Œè®¾ç½®;è®©ç›®å½•ä¸­å“ªä¸ªç”¨æˆ·åˆ›å»ºçš„æ–‡ä»¶åªèƒ½è¢«è¯¥ç”¨æˆ·è‡ªå·±åˆ é™¤,å…¶ä½™äººä¸èƒ½åˆ é™¤
[bavduer@system_manager ~]$ sudo mkdir /opt/directory001
[bavduer@system_manager ~]$ sudo chmod 777 /opt/directory001
[bavduer@system_manager ~]$ sudo chmod o+t /opt/directory001
[bavduer@system_manager ~]$ touch /opt/directory001/Test_bavduer.txt
[bavduer@system_manager ~]$ su - bavduer01
Password:
Last login: Tue Feb 19 15:22:58 CST 2019 on pts/0
[bavduer01@system_manager ~]$ rm -rf /opt/directory001/Test_bavduer.txt
rm: cannot remove â€˜/opt/directory001/Test_bavduer.txtâ€™: Operation not permitted
[bavduer01@system_manager ~]$ ls /opt/directory001/
Test_bavduer.txt
[bavduer01@system_manager ~]$ 
```



#### suå’Œsudoææƒ

su: æŒ‡åˆ‡æ¢ç”¨æˆ·ä½¿ç”¨çš„å‘½ä»¤

sudo: æŒ‡æ™®é€šç”¨æˆ·é’ˆå¯¹æŸæ¡æŒ‡ä»¤ææƒåˆ°rootæƒé™æ‰§è¡Œ

```shell
##sudo
[root@system_manager ~]# useradd -G wheel bavduer			# åœ¨åˆ›å»ºç”¨æˆ·çš„æ—¶å€™åŠ å…¥wheel
[root@system_manager ~]# usermod -aG wheel bavduer		# åœ¨åˆ›å»ºç”¨æˆ·ä¹‹å,è¿½åŠ wheel
[root@system_manager ~]# id bavduer	
uid=1004(bavduer) gid=1004(bavduer) ç»„=1004(bavduer),10(wheel)
[root@system_manager ~]# passwd bavduer
æ›´æ”¹ç”¨æˆ· bavduer çš„å¯†ç  ã€‚
æ–°çš„ å¯†ç ï¼š
æ— æ•ˆçš„å¯†ç ï¼š å¯†ç æ˜¯ä¸€ä¸ªå›æ–‡
é‡æ–°è¾“å…¥æ–°çš„ å¯†ç ï¼š
passwdï¼šæ‰€æœ‰çš„èº«ä»½éªŒè¯ä»¤ç‰Œå·²ç»æˆåŠŸæ›´æ–°ã€‚
[root@system_manager ~]# vim /etc/sudoers.d/bavduer		---å…å¯†æ“ä½œ
bavduer	ALL=(ALL)	NOPASSWD: ALL

##sudoä½¿ç”¨
[root@system_manager ~]# su - bavduer
[bavduer@system_manager ~]$ touch /opt/file999
touch: cannot touch â€˜/opt/file999â€™: Permission denied
[bavduer@system_manager ~]$ sudo touch /opt/file999
[bavduer@system_manager ~]$
```

